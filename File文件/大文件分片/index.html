<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ–‡ä»¶åˆ†ç‰‡</title>
    <style>
        h1 {
            text-align: center;
        }

        .box {
            margin: 20px;
            font-size: 32px;
        }
    </style>
</head>

<body>
    <h1>å¤§æ–‡ä»¶åˆ†ç‰‡ï¼ˆæ™®é€šç‰ˆï¼‰</h1>
    <hr />
    <div class="box">
        md5ï¼š<input type="file" id="file" />
        <h3 id="chunks"></h3>
    </div>
    <div class="box">
        spark-md5ï¼š<input type="file" id="file2" />
        <h3 id="chunks2"></h3>
    </div>

    <script src="./md5.js"></script>
    <script>
        const inpfile = document.querySelector('#file');


        // åˆ›å»ºæ–‡ä»¶åˆ†ç‰‡ï¼ˆé€šè¿‡æ–‡ä»¶åˆ†ç‰‡å†…å®¹è®¡ç®—HASHå€¼ï¼‰
        const createChunk = (file, index, chunkSize) => {
            // console.log(file, index, chunkSize);
            return new Promise((resolve, reject) => {
                const start = index * chunkSize;
                const end = start + chunkSize;
                // æ–‡ä»¶åˆ‡ç‰‡
                const blob = file.slice(start, end);
                const fileReader = new FileReader();

                // ç›‘å¬æ–‡ä»¶åˆ†ç‰‡å†…å®¹åŠ è½½å®Œæˆæ—¶ï¼Œç”¨æ–‡ä»¶åˆ†ç‰‡å†…å®¹è®¡ç®—HASHå€¼ï¼Œä½†è¿™æ ·åšé€Ÿåº¦å¤ªæ…¢äº†ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡æŠ½æ ·çš„å½¢å¼çš„è®¡ç®—HASHå€¼
                fileReader.onload = (e) => {
                    // console.log(e.target.result);
                    resolve({
                        start,
                        end,
                        index,
                        hash: md5(index + e.target.result),
                        blob,
                    });
                };

                // fileReader.onerror = (e) => {
                //     reject(e);
                // };

                // fileReader.onprogress = (e) => {
                //     console.log('åˆ‡ç‰‡è¿›åº¦ï¼š', e);
                // };

                //  å¼€å§‹è¯»å–æŒ‡å®š Blob æˆ– File çš„å†…å®¹ï¼ˆè¯»å–æ“ä½œå®Œæˆæ—¶ï¼ŒreadyState å±æ€§å˜ä¸º DONEï¼Œå¹¶è§¦å‘ loadend äº‹ä»¶ï¼‰
                fileReader.readAsArrayBuffer(blob);
            })
        };

        // åˆ›å»ºæ–‡ä»¶åˆ†ç‰‡ï¼ˆé€šè¿‡åˆ†ç‰‡ç´¢å¼•è®¡ç®—HASHå€¼ï¼‰
        const createChunk2 = (file, index, chunkSize) => {
            // console.log(file, index, chunkSize);
            return new Promise((resolve, reject) => {
                const start = index * chunkSize;
                const end = start + chunkSize;
                // æ–‡ä»¶åˆ‡ç‰‡
                const blob = file.slice(start, end);
                resolve({
                    start,
                    end,
                    index,
                    hash: md5(index),
                    /*
                        åœ¨å‰ç«¯è¿›è¡Œå¤§æ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œè®¡ç®—æ–‡ä»¶çš„å“ˆå¸Œå€¼é€šå¸¸æ˜¯ä¸ºäº†ç¡®ä¿æ–‡ä»¶çš„å®Œæ•´æ€§å’Œå”¯ä¸€æ€§ã€‚
                        ä½¿ç”¨å¾ªç¯æ—¶çš„ç´¢å¼•ï¼ˆindexï¼‰æ¥è®¡ç®—å“ˆå¸Œå€¼å¹¶ä¸æ˜¯ä¸€ä¸ªåˆé€‚çš„æ–¹æ³•ï¼Œ
                        å› ä¸ºç´¢å¼•åªæ˜¯ä¸€ä¸ªå¾ªç¯å˜é‡ï¼Œå¹¶ä¸èƒ½åæ˜ æ–‡ä»¶å†…å®¹çš„å®é™…ä¿¡æ¯ã€‚
                        åœ¨è®¡ç®—å“ˆå¸Œå€¼æ—¶ï¼Œåº”è¯¥ä½¿ç”¨æ–‡ä»¶å†…å®¹çš„å®é™…ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç´¢å¼•æ¥è®¡ç®—å“ˆå¸Œå€¼ã€‚
                        æ‰€ä»¥ å¯ä»¥ç”¨ spark-md5
                    */
                    blob,
                });
            })
        };

        // å®šä¹‰æ–‡ä»¶æ¯ç‰‡çš„åˆ†ç‰‡å¤§å° 5MB
        const CHUNK_SIZE = 1024 * 1024 * 5;

        const cutFile = async (file) => {

            // è®¡ç®—æ–‡ä»¶æ€»åˆ†ç‰‡æ•°
            const chunkCount = Math.ceil(file.size / CHUNK_SIZE); // åˆ†ç‰‡å‘ä¸Šå–æ•´ï¼Œå¦‚ï¼š5.5ç‰‡å°±è¦åˆ†6ç‰‡
            console.log('æ–‡ä»¶æ€»åˆ†ç‰‡æ•°ï¼š', chunkCount);

            console.log('\næ–‡ä»¶åˆ†ç‰‡ä¸­...ï¼ğŸš€å¦‚æœæ–‡ä»¶æ˜¯å­˜å‚¨SSDå›ºæ€ç¡¬ç›˜ä¸­çš„è¯ï¼Œè¯»å–é€Ÿåº¦ä¼šæœ‰éå¸¸å¤§çš„æå‡å“¦ï¼ï¼\n\n');

            const chunks = [];
            // è·å–æ–‡ä»¶åˆ†ç‰‡æ¯ç‰‡çš„ä¿¡æ¯
            for (let i = 0; i < chunkCount; i++) {
                // å¯èƒ½ è¿™é‡Œä¾æ¬¡ç­‰å¾…åˆ›å»ºåˆ†ç‰‡çš„è€—æ—¶å¤ªé•¿äº†
                // const chunk = await createChunk(file, i, CHUNK_SIZE);
                // chunks.push(chunk);

                // æ‰€ä»¥ è¯•å…ˆç›´æ¥æ·»åŠ åˆ†ç‰‡ä»»åŠ¡ï¼Œæœ€åç”¨Promiseå¹¶è¡Œåˆ›å»ºåˆ†ç‰‡
                // chunks.push(createChunk(file, i, CHUNK_SIZE))
                chunks.push(createChunk2(file, i, CHUNK_SIZE))
            }
            // return chunks;
            // æœ€åç”¨Promiseå¹¶è¡Œåˆ›å»ºåˆ†ç‰‡
            return await Promise.all(chunks);

            // é€šè¿‡ä»¥ä¸Šçš„å°è¯•æœ€åé€Ÿåº¦æ•ˆæœéƒ½å·®ä¸å¤š, æ‰€ä»¥å¯ä»¥å°è¯•ç”¨å¤šçº¿ç¨‹workerçš„æ–¹å¼æ¥å¤„ç†ã€‚
        };


        inpfile.onchange = async (e) => {
            const file = e.target.files[0];
            console.time('è€—æ—¶');

            const chunks = await cutFile(file);
            document.querySelector('#chunks').innerText = chunks

            console.log('åˆ†ç‰‡ç»“æœï¼š', chunks);
        }
    </script>

    <script src="./spark-md5.js"></script>
    <script type="module">
        // å¼•å…¥spark-md5åº“
        // import { SparkMD5 } from './spark-md5.js';

        function calculateFileHash(file) {
            return new Promise((resolve, reject) => {
                const spark = new SparkMD5.ArrayBuffer();
                const fileReader = new FileReader();
                /*
                SparkMD5 æ˜¯ MD5 ç®—æ³•çš„å¿«é€Ÿ md5 å®ç°ã€‚æ­¤è„šæœ¬åŸºäº JKM md5 åº“ï¼Œè¿™æ˜¯æœ€å¿«çš„ç®—æ³•ã€‚è¿™æœ€é€‚åˆæµè§ˆå™¨ä½¿ç”¨
                */
                fileReader.onload = (e) => {
                    spark.append(e.target.result); // Append array buffer
                    resolve(spark.end());
                };

                fileReader.onerror = () => {
                    reject('æ— æ³•è¯»å–æ–‡ä»¶');
                };

                fileReader.readAsArrayBuffer(file);
            });
        }

        // å®šä¹‰æ–‡ä»¶æ¯ç‰‡çš„åˆ†ç‰‡å¤§å° 5MB
        const CHUNK_SIZE2 = 1024 * 1024 * 5;

        const cutFile2 = async (file) => {

            // è®¡ç®—æ–‡ä»¶æ€»åˆ†ç‰‡æ•°
            const chunkCount = Math.ceil(file.size / CHUNK_SIZE); // åˆ†ç‰‡å‘ä¸Šå–æ•´ï¼Œå¦‚ï¼š5.5ç‰‡å°±è¦åˆ†6ç‰‡
            console.log('æ–‡ä»¶æ€»åˆ†ç‰‡æ•°ï¼š', chunkCount);

            console.log('\næ–‡ä»¶åˆ†ç‰‡ä¸­...ï¼ğŸš€å¦‚æœæ–‡ä»¶æ˜¯å­˜å‚¨SSDå›ºæ€ç¡¬ç›˜ä¸­çš„è¯ï¼Œè¯»å–é€Ÿåº¦ä¼šæœ‰éå¸¸å¤§çš„æå‡å“¦ï¼ï¼\n\n');

            const chunks = [];
            // è·å–æ–‡ä»¶åˆ†ç‰‡æ¯ç‰‡çš„ä¿¡æ¯
            for (let i = 0; i < chunkCount; i++) {
                chunks.push(calculateFileHash(file, i, CHUNK_SIZE))
            }
            // return chunks;
            // æœ€åç”¨Promiseå¹¶è¡Œåˆ›å»ºåˆ†ç‰‡
            return await Promise.all(chunks);

            // é€šè¿‡ä»¥ä¸Šçš„å°è¯•æœ€åé€Ÿåº¦æ•ˆæœéƒ½å·®ä¸å¤š, æ‰€ä»¥å¯ä»¥å°è¯•ç”¨å¤šçº¿ç¨‹workerçš„æ–¹å¼æ¥å¤„ç†ã€‚
        };

        // ä½¿ç”¨ç¤ºä¾‹
        document.querySelector('#file2').addEventListener('change', async (e) => {

            const file = e.target.files[0];
            console.time('è€—æ—¶');

            const chunks = await cutFile2(file);
            document.querySelector('#chunks2').innerText = chunks

            console.log('åˆ†ç‰‡ç»“æœï¼š', chunks);

        });
    </script>
</body>

</html>