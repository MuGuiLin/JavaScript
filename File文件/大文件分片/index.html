<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ–‡ä»¶åˆ†ç‰‡</title>
    <style>
        h1 {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>å¤§æ–‡ä»¶åˆ†ç‰‡ï¼ˆæ™®é€šç‰ˆï¼‰</h1>
    <hr />
    <input type="file" id="file" />

    <script src="./md5.js"></script>
    <script>
        const inpfile = document.querySelector('#file');


        // åˆ›å»ºæ–‡ä»¶åˆ†ç‰‡ï¼ˆé€šè¿‡æ–‡ä»¶åˆ†ç‰‡å†…å®¹è®¡ç®—HASHå€¼ï¼‰
        const createChunk = (file, index, chunkSize) => {
            // console.log(file, index, chunkSize);
            return new Promise((resolve, reject) => {
                const start = index * chunkSize;
                const end = start + chunkSize;
                // æ–‡ä»¶åˆ‡ç‰‡
                const blob = file.slice(start, end);
                const fileReader = new FileReader();

                // ç›‘å¬æ–‡ä»¶åˆ†ç‰‡å†…å®¹åŠ è½½å®Œæˆæ—¶ï¼Œç”¨æ–‡ä»¶åˆ†ç‰‡å†…å®¹è®¡ç®—HASHå€¼ï¼Œä½†è¿™æ ·åšé€Ÿåº¦å¤ªæ…¢äº†ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡æŠ½æ ·çš„å½¢å¼çš„è®¡ç®—HASHå€¼
                fileReader.onload = (e) => {
                    // console.log(e.target.result);
                    resolve({
                        start,
                        end,
                        index,
                        hash: md5(index + e.target.result),
                        blob,
                    });
                };

                // fileReader.onerror = (e) => {
                //     reject(e);
                // };

                // fileReader.onprogress = (e) => {
                //     console.log('åˆ‡ç‰‡è¿›åº¦ï¼š', e);
                // };
                
                //  å¼€å§‹è¯»å–æŒ‡å®š Blob æˆ– File çš„å†…å®¹ï¼ˆè¯»å–æ“ä½œå®Œæˆæ—¶ï¼ŒreadyState å±æ€§å˜ä¸º DONEï¼Œå¹¶è§¦å‘ loadend äº‹ä»¶ï¼‰
                fileReader.readAsArrayBuffer(blob);
            })
        };

        // åˆ›å»ºæ–‡ä»¶åˆ†ç‰‡ï¼ˆé€šè¿‡åˆ†ç‰‡ç´¢å¼•è®¡ç®—HASHå€¼ï¼‰
        const createChunk2 = (file, index, chunkSize) => {
            // console.log(file, index, chunkSize);
            return new Promise((resolve, reject) => {
                const start = index * chunkSize;
                const end = start + chunkSize;
                // æ–‡ä»¶åˆ‡ç‰‡
                const blob = file.slice(start, end);
                resolve({
                    start,
                    end,
                    index,
                    hash: md5(index),
                    blob,
                });
            })
        };

        // å®šä¹‰æ–‡ä»¶æ¯ç‰‡çš„åˆ†ç‰‡å¤§å° 5MB
        const CHUNK_SIZE = 1024 * 1024 * 5;

        const cutFile = async (file) => {

            // è®¡ç®—æ–‡ä»¶æ€»åˆ†ç‰‡æ•°
            const chunkCount = Math.ceil(file.size / CHUNK_SIZE); // åˆ†ç‰‡å‘ä¸Šå–æ•´ï¼Œå¦‚ï¼š5.5ç‰‡å°±è¦åˆ†6ç‰‡
            console.log('æ–‡ä»¶æ€»åˆ†ç‰‡æ•°ï¼š', chunkCount);

            console.log('\næ–‡ä»¶åˆ†ç‰‡ä¸­...ï¼ğŸš€å¦‚æœæ–‡ä»¶æ˜¯å­˜å‚¨SSDå›ºæ€ç¡¬ç›˜ä¸­çš„è¯ï¼Œè¯»å–é€Ÿåº¦ä¼šæœ‰éå¸¸å¤§çš„æå‡å“¦ï¼ï¼\n\n');

            const chunks = [];
            // è·å–æ–‡ä»¶åˆ†ç‰‡æ¯ç‰‡çš„ä¿¡æ¯
            for (let i = 0; i < chunkCount; i++) {
                // å¯èƒ½ è¿™é‡Œä¾æ¬¡ç­‰å¾…åˆ›å»ºåˆ†ç‰‡çš„è€—æ—¶å¤ªé•¿äº†
                // const chunk = await createChunk(file, i, CHUNK_SIZE);
                // chunks.push(chunk);

                // æ‰€ä»¥ è¯•å…ˆç›´æ¥æ·»åŠ åˆ†ç‰‡ä»»åŠ¡ï¼Œæœ€åç”¨Promiseå¹¶è¡Œåˆ›å»ºåˆ†ç‰‡
                // chunks.push(createChunk(file, i, CHUNK_SIZE))
                chunks.push(createChunk2(file, i, CHUNK_SIZE))
            }
            // return chunks;
            // æœ€åç”¨Promiseå¹¶è¡Œåˆ›å»ºåˆ†ç‰‡
            return await Promise.all(chunks);

            // é€šè¿‡ä»¥ä¸Šçš„å°è¯•æœ€åé€Ÿåº¦æ•ˆæœéƒ½å·®ä¸å¤š, æ‰€ä»¥å¯ä»¥å°è¯•ç”¨å¤šçº¿ç¨‹workerçš„æ–¹å¼æ¥å¤„ç†ã€‚
        };


        inpfile.onchange = async (e) => {
            const file = e.target.files[0];
            console.time('è€—æ—¶');

            const chunks = await cutFile(file);
            console.timeEnd('è€—æ—¶');

            console.log('åˆ†ç‰‡ç»“æœï¼š', chunks);
        }
    </script>
</body>

</html>