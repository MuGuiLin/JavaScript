<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ–‡ä»¶åˆ†ç‰‡</title>
    <style>
        h1 {
            text-align: center;
        }
    </style>
</head>

<body>
    <h1>å¤§æ–‡ä»¶åˆ†ç‰‡ï¼ˆå¤šçº¿ç¨‹ç‰ˆï¼‰</h1>
    <hr />
    <input type="file" id="file" />

    <script src="./md5.js"></script>
    <script>
        const inpfile = document.querySelector('#file');


        // å®šä¹‰æ–‡ä»¶æ¯ç‰‡çš„åˆ†ç‰‡å¤§å° 5MB
        const CHUNK_SIZE = 1024 * 1024 * 5;

        // è·å–å½“å‰è®¡ç®—æœºCUPæ ¸å¿ƒæ•°
        const CUP_THREAD_NUM = globalThis.navigator.hardwareConcurrency || 4;

        const cutFile = async (file) => {
            return new Promise((resolve, reject) => {
                // è®¡ç®—æ–‡ä»¶æ€»åˆ†ç‰‡æ•°
                const chunkCount = Math.ceil(file.size / CHUNK_SIZE); // åˆ†ç‰‡å‘ä¸Šå–æ•´ï¼Œå¦‚ï¼š5.5ç‰‡å°±è¦åˆ†6ç‰‡
                console.log('æ–‡ä»¶æ€»åˆ†ç‰‡æ•°ï¼š', chunkCount);

                // è®¡ç®—æ¯ä¸ªçº¿ç¨‹èƒ½å¤Ÿåˆ†åˆ°çš„åˆ†ç‰‡æ•°é‡
                const hereadChunkCount = Math.ceil(chunkCount / CUP_THREAD_NUM);
                console.log('æ¯ä¸ªçº¿ç¨‹åˆ†ç‰‡æ•°ï¼š', hereadChunkCount);


                console.log('\næ–‡ä»¶åˆ†ç‰‡ä¸­...ï¼ğŸš€å¦‚æœæ–‡ä»¶æ˜¯å­˜å‚¨SSDå›ºæ€ç¡¬ç›˜ä¸­çš„è¯ï¼Œè¯»å–é€Ÿåº¦ä¼šæœ‰éå¸¸å¤§çš„æå‡å“¦ï¼ï¼\n\n');


                const chunks = [];
                let finishCount = 0; //å®Œæˆçš„åˆ†ç‰‡æ•°

                // æ ¹æ®CUPæ ¸å¿ƒæ•° åˆ›å»ºçº¿ç¨‹ï¼Œå¹¶åˆ†é…è·å–æ–‡ä»¶åˆ†ç‰‡æ¯ç‰‡ä¿¡æ¯çš„ä»»åŠ¡
                for (let i = 0; i < CUP_THREAD_NUM; i++) {

                    // ä½¿ç”¨çº¿ç¨‹æ¥å®Œæˆç‰‡ä¿¡ä»»åŠ¡ï¼Œè¿™æ ·å°±ä¸å½±å“ä¸»(æ¸²æŸ“)çº¿ç¨‹ï¼Œä»è€Œè¾¾åˆ°æå‡æ–‡ä»¶åˆ†ç‰‡çš„ä»»åŠ¡ï¼ï¼æ³¨ï¼šWorkerè¦åœ¨httpæœåŠ¡å™¨ç¯å¢ƒä¸‹æ‰èƒ½è¿è¡Œï¼ï¼
                    // const worker = new Worker('./worker.js', {
                    //     type: 'module'   // å¯ä»¥åœ¨worker.jsä¸­å¯¼å…¥å…¶ä»–jsæ¨¡å—
                    // });
                    const worker = new Worker('./worker.js');
                    // çº¿ç¨‹è¦å¤„ç†åˆ†ç‰‡çš„èµ·å§‹ä½ç½®
                    let startChunkIndex = i * hereadChunkCount;
                    // çº¿ç¨‹è¦å¤„ç†åˆ†ç‰‡çš„ç»“æŸä½ç½®
                    let endChunkIndex = (i + 1) * hereadChunkCount;
                    // å¦‚æœendChunkIndexè¶…å‡ºäº†æ€»åˆ†ç‰‡æ•°é‡ï¼Œå°±ç­‰äºæ€»åˆ†ç‰‡æ•°é‡
                    if (chunkCount < endChunkIndex) {
                        endChunkIndex = chunkCount;
                    }
                    // å¾€çº¿ç¨‹ä¼ é€’æ¶ˆæ¯ï¼ˆæ¯ä¸ªçº¿ç¨‹è¦å¤„ç†å¤šä¸ªåˆ†ç‰‡ä»»åŠ¡ï¼‰
                    worker.postMessage({
                        file,           // è¦åˆ†ç‰‡çš„æ–‡ä»¶
                        CHUNK_SIZE,     // æ¯ä¸ªåˆ†ç‰‡çš„å¤§å°
                        startChunkIndex,// çº¿ç¨‹è¦å¤„ç†åˆ†ç‰‡çš„èµ·å§‹ä½ç½®
                        endChunkIndex,  // çº¿ç¨‹è¦å¤„ç†åˆ†ç‰‡çš„ç»“æŸä½ç½®
                    });
                    // æ¥æ”¶çº¿ç¨‹å¤„ç†ç»“æœ
                    worker.onmessage = (e) => {
                        // è¿™æ ·ç›´æ¥æ·»åŠ ä¼šé€ æˆæ–‡ä»¶åˆ†ç‰‡çš„é¡ºåºæ··ä¹±ï¼Œå› ä¸ºæ²¡æ³•ç¡®å®šå“ªä¸ªçº¿ç¨‹ä»»åŠ¡å…ˆå®Œæˆå’Œåå®Œæˆã€‚
                        // chunks.push(...e.data);

                        // æ‰€ä»¥ç»™çº¿ç¨‹ä»»åŠ¡å¯¹åº”çš„ä¸‹æ ‡èµ‹å€¼æ–‡ä»¶åˆ†ç‰‡ï¼Œå°±ä¸ä¼šæœ‰é¡ºåºæ··ä¹±çš„é—®é¢˜äº†
                        for (let i = startChunkIndex; i < endChunkIndex; i++) {
                            // å°†çº¿ç¨‹æ¯æ¬¡åˆ†ç‰‡ä»»åŠ¡å®Œæˆçš„ç»“æœï¼Œä¾æ¬¡æ±‡æ€»
                            chunks[i] = e.data[i - startChunkIndex];
                        }
                        // æ¯å®Œæˆä¸€ä¸ªçº¿ç¨‹ï¼Œå°±ç»“æŸä¸€ä¸ªçº¿ç¨‹
                        worker.terminate();
                        // æ¯å®Œæˆä¸€ä¸ªçº¿ç¨‹ï¼Œå°±è®°å½•ä¸ŠåŠ ä¸€æ¬¡
                        finishCount++;
                        // å½“æ‰€æœ‰çº¿ç¨‹ä»»åŠ¡éƒ½å®Œæˆæ—¶ï¼Œåè¿”å›åˆ†ç‰‡ç»“æœ
                        if (finishCount === CUP_THREAD_NUM) {
                            resolve(chunks)
                        }
                    }
                }
            });
        };

        inpfile.onchange = async (e) => {
            const file = e.target.files[0];
            console.time('è€—æ—¶');

            const chunks = await cutFile(file);

            console.timeEnd('è€—æ—¶');

            console.log('åˆ†ç‰‡ç»“æœï¼š', chunks);
        }
    </script>
</body>

</html>