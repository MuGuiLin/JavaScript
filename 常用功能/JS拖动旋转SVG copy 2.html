<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Rect Drag and Rotate with Handle</title>
    <style>
        svg {
            border: 1px solid black;
        }

        rect {
            fill: lightblue;
            cursor: pointer;
        }

        .rotate-handle {
            fill: red;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <svg width="500" height="500">
        <!-- 包裹矩形的 g 元素 -->
        <g id="group" transform="translate(150, 150) rotate(0)">
            <rect id="rect" width="100" height="60" />
        </g>
        <!-- 包裹旋转按钮的 g 元素 -->
        <g id="handle-group">
            <circle id="rotate-handle" class="rotate-handle" cx="250" cy="120" r="8" />
        </g>
    </svg>

    <script>
        const svg = document.querySelector('svg');
        const rect = document.getElementById('rect');
        const group = document.getElementById('group');
        const handleGroup = document.getElementById('handle-group');
        const handle = document.getElementById('rotate-handle');

        // 使用对象来管理旋转和拖动相关的数据
        const rotationData = {
            isRotating: false,
            isDragging: false,
            startX: 0,
            startY: 0,
            startAngle: 0,
            currentRotation: 0,
            translateX: 150, // 矩形的初始X位置
            translateY: 150, // 矩形的初始Y位置
            centerX: 50, // 矩形宽度的中心
            centerY: 30, // 矩形高度的中心
            handleOffsetX: 0, // 旋转按钮与矩形中心的X偏移量
            handleOffsetY: 0  // 旋转按钮与矩形中心的Y偏移量
        };

        // 计算鼠标位置与矩形中心的角度
        function calculateAngle(x, y) {
            const dx = x - rotationData.translateX - rotationData.centerX;
            const dy = y - rotationData.translateY - rotationData.centerY;
            return Math.atan2(dy, dx) * 180 / Math.PI;
        }

        // 更新旋转按钮的位置
        function updateHandlePosition() {
            const handleX = rotationData.translateX + Math.cos(rotationData.currentRotation * Math.PI / 180) * 150;
            const handleY = rotationData.translateY + Math.sin(rotationData.currentRotation * Math.PI / 180) * 150;
            handle.setAttribute('cx', handleX);
            handle.setAttribute('cy', handleY);
        }

        // 鼠标按下事件 - 开始旋转
        handle.addEventListener('mousedown', function (e) {
            rotationData.isRotating = true;
            rotationData.startX = e.clientX;
            rotationData.startY = e.clientY;
            rotationData.startAngle = calculateAngle(rotationData.startX, rotationData.startY);
            svg.style.cursor = 'move'; // 改变光标
        });

        // 鼠标移动事件 - 更新旋转角度
        svg.addEventListener('mousemove', function (e) {
            if (rotationData.isRotating) {
                const angle = calculateAngle(e.clientX, e.clientY); // 计算新的角度
                const deltaAngle = angle - rotationData.startAngle; // 角度差

                // 更新旋转
                rotationData.currentRotation += deltaAngle;
                group.setAttribute('transform', `translate(${rotationData.translateX}, ${rotationData.translateY}) rotate(${rotationData.currentRotation}, ${rotationData.centerX}, ${rotationData.centerY})`);

                // 更新旋转按钮的位置
                updateHandlePosition();

                rotationData.startAngle = angle; // 更新开始角度
            }

            // 如果拖动矩形
            if (rotationData.isDragging) {
                const dx = e.clientX - rotationData.startX;
                const dy = e.clientY - rotationData.startY;

                rotationData.translateX += dx;
                rotationData.translateY += dy;

                // 更新矩形位置
                group.setAttribute('transform', `translate(${rotationData.translateX}, ${rotationData.translateY}) rotate(${rotationData.currentRotation}, ${rotationData.centerX}, ${rotationData.centerY})`);

                // 更新旋转按钮位置
                updateHandlePosition();

                rotationData.startX = e.clientX;
                rotationData.startY = e.clientY;
            }
        });

        // 鼠标松开事件 - 停止旋转或拖动
        svg.addEventListener('mouseup', function () {
            rotationData.isRotating = false;
            rotationData.isDragging = false;
            svg.style.cursor = 'default'; // 恢复光标
        });

        // 鼠标按下事件 - 开始拖动矩形
        group.addEventListener('mousedown', function (e) {
            // 只在鼠标点击矩形时启用拖动
            if (!rotationData.isRotating) {
                rotationData.isDragging = true;
                rotationData.startX = e.clientX;
                rotationData.startY = e.clientY;
            }
        });
    </script>
</body>

</html>