<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selection Component</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --hover-bg: #f5f5f5;
            --border-color: #e8e8e8;
            --text-color: #333;
            --secondary-text: #666;
            --item-height: 32px;
            /* è™šæ‹Ÿæ»šåŠ¨çš„å›ºå®šé«˜åº¦ */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            background: #fff;
            display: flex;
            flex-direction: column;
        }

        /* å®¹å™¨åˆ†å‰² */
        .container {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        .left-panel,
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 16px;
        }

        .left-panel {
            border-right: 1px solid var(--border-color);
        }

        /* æœç´¢æ¡† */
        .search-box {
            margin-bottom: 12px;
            position: relative;
            flex-shrink: 0;
        }

        .search-box input {
            width: 100%;
            padding: 8px 30px 8px 34px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
        }

        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #ccc;
        }

        .clear-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #FFF;
            cursor: pointer;
            display: none;
            font-size: 16px;
            background: #ddd;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            text-align: center;
            line-height: 13px;
        }

        .clear-icon:hover {
            color: red;
        }

        /* æ ‘å½¢è§†å›¾ - è™šæ‹Ÿæ»šåŠ¨ */
        .tree-viewport {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .tree-phantom {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            z-index: -1;
        }

        .tree-content {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
        }

        .tree-node {
            display: flex;
            align-items: center;
            height: var(--item-height);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .tree-node:hover {
            background-color: var(--hover-bg);
        }

        .u-icon {
            margin: 0 6px;
            font-size: 16px;
            color: var(--primary-color);
        }

        .toggle-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            transition: transform 0.2s;
            font-size: 12px;
        }

        .toggle-icon.expanded {
            transform: rotate(90deg);
        }

        .toggle-icon.leaf {
            visibility: hidden;
        }

        /* å³ä¾§é¢æ¿ - å·²é€‰åˆ—è¡¨ */
        .selected-header {
            font-size: 14px;
            color: #999;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .selected-list {
            flex: 1;
            overflow-y: auto;
        }

        .selected-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f9f9f9;
        }

        .selected-item:hover {
            background-color: var(--hover-bg);
        }

        .item-info {
            display: flex;
            align-items: center;
            overflow: hidden;
        }

        .item-info span:last-child {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .remove-btn {
            color: #999;
            cursor: pointer;
            font-size: 22px;
            margin-left: 10px;
            padding: 0 8px;
            flex-shrink: 0;
        }

        .remove-btn:hover {
            color: #ff4d4f;
        }

        .check-mark {
            color: var(--primary-color);
            font-weight: bold;
            margin-right: 8px;
            visibility: hidden;
        }

        .check-mark.checked {
            visibility: visible;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #999;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å·¦ä¾§é¢æ¿ -->
        <div class="left-panel">
            <div class="search-box">
                <span class="search-icon">ğŸ”</span>
                <input type="text" placeholder="æœç´¢ éƒ¨é—¨ã€äººå‘˜" id="searchInput">
                <span class="clear-icon" id="clearBtn">Ã—</span>
            </div>

            <div class="tree-viewport" id="treeViewport">
                <div class="loading" id="loading">åŠ è½½ä¸­...</div>
                <div class="tree-phantom" id="treePhantom"></div>
                <div class="tree-content" id="treeContent"></div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ -->
        <div class="right-panel">
            <div class="selected-header">
                å·²é€‰æ‹©çš„äººå‘˜ (<span id="selectedCount">0</span>)
            </div>
            <div class="selected-list" id="selectedList">
                <!-- å·²é€‰é¡¹ç›®å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <script>
        // --- é…ç½® ---
        const API_URL = '/api/org-structure'; // Todo: çœŸå®ä¸Šçº¿æ—¶ä¿®æ”¹æ­¤APIåœ°å€ mock: /api/org-structure
        const USE_MOCK_SERVER = true;         // Todo: çœŸå®ä¸Šçº¿æ—¶è®¾ä¸º false

        // --- æ¨¡æ‹ŸæœåŠ¡å™¨è®¾ç½® ---
        if (USE_MOCK_SERVER) {
            (function () {
                console.log('--- å¯ç”¨æ¨¡æ‹ŸæœåŠ¡å™¨ ---');

                // ç”Ÿæˆå¤§æ•°æ®åŠ©æ‰‹å‡½æ•°
                function generateLargeData() {
                    console.log('æ¨¡æ‹ŸæœåŠ¡å™¨: æ­£åœ¨ç”Ÿæˆ 10k æ•°æ®...');
                    const roots = [];
                    for (let i = 1; i <= 5; i++) {
                        const root = {
                            id: `root-${i}`,
                            name: `æ€»éƒ¨æœºæ„ ${i}`,
                            type: 'dept',
                            expanded: false,
                            children: []
                        };
                        for (let j = 1; j <= 20; j++) {
                            const dept = {
                                id: `dept-${i}-${j}`,
                                name: `ç ”å‘éƒ¨é—¨ ${i}-${j}`,
                                type: 'dept',
                                expanded: false,
                                children: []
                            };
                            for (let k = 1; k <= 100; k++) {
                                const user = {
                                    id: `user-${i}-${j}-${k}`,
                                    name: `å·¥ç¨‹å¸ˆ ${i}-${j}-${k}`,
                                    type: 'user',
                                    expanded: false,
                                    children: []
                                };
                                dept.children.push(user);
                            }
                            root.children.push(dept);
                        }
                        roots.push(root);
                    }
                    console.log('æ¨¡æ‹ŸæœåŠ¡å™¨: æ•°æ®å·²ç”Ÿæˆã€‚');
                    return roots;
                }

                const mockData = generateLargeData();
                const OriginalXHR = window.XMLHttpRequest;

                // æ‹¦æˆª XMLHttpRequest
                window.XMLHttpRequest = class MockXHR extends OriginalXHR {
                    constructor() {
                        super();
                        this._url = '';
                        this._method = '';
                    }

                    open(method, url) {
                        this._method = method;
                        this._url = url;
                        super.open(method, url);
                    }

                    send(body) {
                        if (this._url === API_URL) {
                            console.log(`æ¨¡æ‹ŸæœåŠ¡å™¨: æ‹¦æˆªåˆ°è¯·æ±‚ ${this._url}`);
                            // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                            setTimeout(() => {
                                // æˆ‘ä»¬æ— æ³•è½»æ˜“å†™å…¥æ ‡å‡† XHR çš„åªè¯»å±æ€§ï¼Œ
                                // ä½†å¯ä»¥è§¦å‘å®šä¹‰åœ¨ 'this' å®ä¾‹ä¸Šçš„äº‹ä»¶ã€‚

                                // åˆ›å»ºå“åº”
                                const responseData = JSON.stringify(mockData);

                                // å®šä¹‰å®ä¾‹å±æ€§ä»¥è¦†ç›–åŸå‹ getterï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œ
                                // æˆ–è€…å¦‚æœå®ƒä»¬æ˜¯å¯å†™çš„ï¼Œç›´æ¥è®¾ç½®å³å¯ã€‚
                                // æ³¨æ„ï¼šåœ¨è®¸å¤šæµè§ˆå™¨ä¸­è¿™äº›æ˜¯åªè¯»çš„ã€‚
                                Object.defineProperty(this, 'responseText', { value: responseData, writable: true });
                                Object.defineProperty(this, 'response', { value: responseData, writable: true });
                                Object.defineProperty(this, 'status', { value: 200, writable: true });
                                Object.defineProperty(this, 'readyState', { value: 4, writable: true });
                                Object.defineProperty(this, 'statusText', { value: 'OK', writable: true });

                                if (this.onreadystatechange) {
                                    this.onreadystatechange();
                                }
                                if (this.onload) {
                                    this.onload();
                                }
                            }, 500); // 500ms å»¶è¿Ÿ
                        } else {
                            // æ”¾è¡ŒæœªçŸ¥è¯·æ±‚
                            super.send(body);
                        }
                    }
                };
            })();
        }

        // --- å¸¸é‡ ---
        const ITEM_HEIGHT = 32;

        // --- çŠ¶æ€ ---
        const state = {
            selectedIds: new Set(),
            selectedNodes: [],
            treeData: [],
            flatNodes: [],
            searchKeyword: '',
            scrollTop: 0
        };

        // --- DOM å…ƒç´  ---
        const treeViewport = document.getElementById('treeViewport');
        const treePhantom = document.getElementById('treePhantom');
        const treeContent = document.getElementById('treeContent');
        const selectedListEl = document.getElementById('selectedList');
        const selectedCountEl = document.getElementById('selectedCount');
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        const loadingEl = document.getElementById('loading');

        // --- è·å–æ•°æ® (çœŸå®ä»£ç ) ---
        function fetchData() {
            loadingEl.style.display = 'block';

            const xhr = new XMLHttpRequest();
            xhr.open('GET', API_URL);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    loadingEl.style.display = 'none';
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            originalData = JSON.parse(JSON.stringify(data)); // æ·±æ‹·è´ä½œä¸ºä¸»æ•°æ®
                            state.treeData = data;
                            state.flatNodes = flattenTree(state.treeData);
                            renderVirtualTree();
                        } catch (e) {
                            console.error('JSON è§£æå¤±è´¥', e);
                            alert('æ•°æ®åŠ è½½å¤±è´¥');
                        }
                    } else {
                        console.error('API é”™è¯¯', xhr.status, xhr.statusText);
                        alert('æ•°æ®è¯·æ±‚å¤±è´¥');
                    }
                }
            };
            xhr.onerror = function () {
                loadingEl.style.display = 'none';
                console.error('ç½‘ç»œé”™è¯¯');
                alert('ç½‘ç»œé”™è¯¯');
            };
            xhr.send();
        }

        // --- æ ¸å¿ƒé€»è¾‘: æ‰å¹³åŒ–æ ‘ ---
        function flattenTree(nodes, level = 0, result = []) {
            for (const node of nodes) {
                result.push({ ...node, level });
                if (node.expanded && node.children && node.children.length > 0) {
                    flattenTree(node.children, level + 1, result);
                }
            }
            return result;
        }

        // --- æ ¸å¿ƒé€»è¾‘: è¿‡æ»¤ ---
        function filterData(nodes, keyword) {
            const result = [];
            for (const node of nodes) {
                const isMatch = node.name.toLowerCase().includes(keyword.toLowerCase());

                let filteredChildren = [];
                let hasMatchingChildren = false;

                if (node.children && node.children.length > 0) {
                    filteredChildren = filterData(node.children, keyword);
                    hasMatchingChildren = filteredChildren.length > 0;
                }

                if (isMatch || hasMatchingChildren) {
                    const newNode = { ...node, children: filteredChildren };
                    if (hasMatchingChildren) {
                        newNode.expanded = true;
                    }
                    result.push(newNode);
                }
            }
            return result;
        }

        // --- è™šæ‹Ÿæ¸²æŸ“ ---
        function renderVirtualTree() {
            const viewportHeight = treeViewport.clientHeight;
            const totalHeight = state.flatNodes.length * ITEM_HEIGHT;

            treePhantom.style.height = `${totalHeight}px`;

            const scrollTop = treeViewport.scrollTop;
            const startIndex = Math.floor(scrollTop / ITEM_HEIGHT);
            const endIndex = Math.min(state.flatNodes.length, Math.ceil((scrollTop + viewportHeight) / ITEM_HEIGHT) + 1);

            const fragment = document.createDocumentFragment();

            for (let i = startIndex; i < endIndex; i++) {
                const flatNode = state.flatNodes[i];
                const nodeEl = createNodeElement(flatNode);
                fragment.appendChild(nodeEl);
            }

            treeContent.innerHTML = '';
            treeContent.appendChild(fragment);
            treeContent.style.transform = `translateY(${startIndex * ITEM_HEIGHT}px)`;
        }

        function createNodeElement(flatNode) {
            const row = document.createElement('div');
            row.className = 'tree-node';
            row.style.paddingLeft = `${flatNode.level * 20}px`;

            const toggleBtn = document.createElement('div');
            const hasChildren = flatNode.children && flatNode.children.length > 0;
            toggleBtn.className = `toggle-icon ${hasChildren ? (flatNode.expanded ? 'expanded' : '') : 'leaf'}`;
            toggleBtn.textContent = 'â–¶';
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                if (hasChildren) toggleNode(flatNode.id);
            };
            row.appendChild(toggleBtn);

            const icon = document.createElement('span');
            icon.className = `u-icon ${flatNode.type}`;
            icon.textContent = flatNode.type === 'dept' ? 'ğŸ“‚' : 'ğŸ‘¤';
            row.appendChild(icon);

            const name = document.createElement('span');
            name.textContent = flatNode.name;
            name.style.flex = 1;
            name.style.marginLeft = '4px';
            row.appendChild(name);

            const isSelected = state.selectedIds.has(flatNode.id);
            const check = document.createElement('div');
            check.className = `check-mark ${isSelected ? 'checked' : ''}`;
            check.textContent = 'âœ“';
            row.appendChild(check);

            row.onclick = () => {
                handleCheck(flatNode);
            };

            return row;
        }

        // --- äº¤äº’é€»è¾‘ ---
        function toggleNode(id) {
            function toggle(nodes) {
                for (const node of nodes) {
                    if (node.id === id) {
                        node.expanded = !node.expanded;
                        return true;
                    }
                    if (node.children && toggle(node.children)) return true;
                }
                return false;
            }
            toggle(state.treeData);
            state.flatNodes = flattenTree(state.treeData);
            renderVirtualTree();
        }

        function handleCheck(node) {
            const id = node.id;
            if (state.selectedIds.has(id)) {
                state.selectedIds.delete(id);
                state.selectedNodes = state.selectedNodes.filter(n => n.id !== id);
            } else {
                state.selectedIds.add(id);
                state.selectedNodes.push({ id: node.id, name: node.name, type: node.type });
            }
            renderVirtualTree();
            renderSelectedList();
        }

        function renderSelectedList() {
            selectedCountEl.textContent = state.selectedIds.size;
            selectedListEl.innerHTML = '';

            const MAX_RENDER = 200;
            const itemsToRender = state.selectedNodes.slice(0, MAX_RENDER);

            const fragment = document.createDocumentFragment();
            itemsToRender.forEach(node => {
                const item = document.createElement('div');
                item.className = 'selected-item';

                const info = document.createElement('div');
                info.className = 'item-info';

                const icon = document.createElement('span');
                icon.className = `u-icon ${node.type}`;
                icon.textContent = node.type === 'dept' ? 'ğŸ“‚' : 'ğŸ‘¤';

                const name = document.createElement('span');
                name.textContent = node.name;
                name.style.marginLeft = '8px';

                info.appendChild(icon);
                info.appendChild(name);

                const remove = document.createElement('div');
                remove.className = 'remove-btn';
                remove.textContent = 'Ã—';
                remove.onclick = () => {
                    state.selectedIds.delete(node.id);
                    state.selectedNodes = state.selectedNodes.filter(n => n.id !== node.id);
                    renderVirtualTree();
                    renderSelectedList();
                };

                item.appendChild(info);
                item.appendChild(remove);
                fragment.appendChild(item);
            });

            if (state.selectedNodes.length > MAX_RENDER) {
                const more = document.createElement('div');
                more.style.padding = '8px';
                more.style.textAlign = 'center';
                more.style.color = '#999';
                more.textContent = `è¿˜æœ‰ ${state.selectedNodes.length - MAX_RENDER} ä¸ªé¡¹æœªæ˜¾ç¤º...`;
                fragment.appendChild(more);
            }

            selectedListEl.appendChild(fragment);
        }

        // --- æœç´¢ ---
        let debounceTimer = null;
        let originalData = null; // ç”¨äºå­˜å‚¨ fetch åçš„åˆå§‹æ•°æ®

        searchInput.addEventListener('input', (e) => {
            const keyword = e.target.value.trim();
            if (keyword === state.searchKeyword) return;
            state.searchKeyword = keyword;

            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                performSearch(keyword);
            }, 300);

            clearBtn.style.display = keyword ? 'block' : 'none';
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            state.searchKeyword = '';
            clearBtn.style.display = 'none';
            performSearch('');
        });

        function performSearch(keyword) {
            // éœ€è¦åŸå§‹æ•°æ®å¼•ç”¨
            // å¦‚æœæˆ‘ä»¬æ­£åœ¨æœç´¢...
            if (!originalData && state.treeData.length > 0) {
                // é¦–æ¬¡æœç´¢?
            }

            if (!keyword) {
                state.treeData = originalData;
            } else {
                state.treeData = filterData(originalData, keyword);
            }
            state.flatNodes = flattenTree(state.treeData);
            treeViewport.scrollTop = 0;
            renderVirtualTree();
        }

        // --- äº‹ä»¶ç›‘å¬ ---
        treeViewport.addEventListener('scroll', () => {
            window.requestAnimationFrame(renderVirtualTree);
        });

        // --- åˆå§‹åŒ– ---
        fetchData(); // å¯åŠ¨æ—¶åŠ è½½æ•°æ®

        // --- API (PostMessage é€šä¿¡) ---
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'GET_SELECTED_ITEMS') {
                const data = JSON.parse(JSON.stringify(state.selectedNodes));
                event.source.postMessage({
                    type: 'SELECTED_ITEMS_DATA',
                    data: data
                }, '*');
            }
        });

    </script>
</body>

</html>